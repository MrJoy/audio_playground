#!/usr/bin/env ruby

###############################################################################
# Early Initialization/Helpers
###############################################################################
lib = File.expand_path("../../lib", __FILE__)
$LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)
require "sparkle_motion"
SparkleMotion.init!("on")
SparkleMotion.use_hue!(api: true)
LOGGER = SparkleMotion.logger
extend SparkleMotion::Hue::HTTP

###############################################################################
# Effect
#
# Tweak this to change the visual effect.
###############################################################################
INIT_HUE      = env_int("INIT_HUE", true) || 49_500
INIT_SAT      = env_int("INIT_SAT", true) || 254
INIT_BRI      = env_int("INIT_BRI", true) || 127
# TODO: Override concurrency settings to ensure we have one conn per bridge.

###############################################################################
# Helper Functions
###############################################################################
def make_req_struct(url, data)
  { method:   :put,
    url:      url,
    put_data: Oj.dump(data) }.merge(SparkleMotion::Hue::HTTP::EASY_OPTIONS)
end

def hue_init(config)
  make_req_struct(hue_group_endpoint(config, 0), "on"  => true,
                                                 "bri" => INIT_BRI,
                                                 "sat" => INIT_SAT,
                                                 "hue" => INIT_HUE)
end

###############################################################################
# Main
###############################################################################
# TODO: Hoist common code from sm-on, sm-off, sm-mark-lights...
requests  = CONFIG["bridges"]
            .values
            .map { |config| hue_init(config) }
reqs      = Hash[requests.map { |req| [req[:url], req.dup] }]
retries   = 0
while requests.length > 0
  retry_queue = []
  Curl::Multi.http(requests, SparkleMotion::Hue::HTTP::MULTI_OPTIONS) do |easy|
    puts easy.url
    if easy.response_code != 200 || easy.body =~ /error/
      url = easy.url
      LOGGER.error { "#{url} => #{easy.response_code} / #{easy.body}" }
      retry_queue << url
    end
  end
  requests = retry_queue.map { |url| reqs[url] }
  retries += 1
  sleep 0.5 * (2**retries) if requests.length > 0
end
